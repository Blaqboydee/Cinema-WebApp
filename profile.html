<!DOCTYPE html>
<html lang="en">
<head>
    <title>myCinema | My Profile - Manage bookings</title>
    <link rel="shortcut icon" href="WhatsApp Image 2025-03-08 at 22.03.05_91a1316a.jpg" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Lora&family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="profile.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <h2>My Bookings</h2>
    
    <!-- Loading Spinner -->
    <div class="loading-container active" id="loadingSpinner">
        <div class="spinner"></div>
        <p class="loading-text">Loading your bookings...</p>
    </div>
    
    <div id="bookings"></div>
    <a href="index.html" class="goHome">Home</a>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyiKbmo11gTMiCtnGat1dmefuCD4SsOQw",
            authDomain: "my-cinema-ffb85.firebaseapp.com",
            databaseURL: "https://my-cinema-ffb85-default-rtdb.firebaseio.com",
            projectId: "my-cinema-ffb85",
            storageBucket: "my-cinema-ffb85.appspot.com",
            messagingSenderId: "1049223253912",
            appId: "1:1049223253912:web:4a244001cd80720753e5ed",
            measurementId: "G-H8NBJJMKX3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Show loading skeleton
        function showSkeletonLoader() {
            const bookingsDiv = document.getElementById("bookings");
            bookingsDiv.innerHTML = `
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
                <div class="skeleton skeleton-card"></div>
            `;
        }

        // Hide loading spinner
        function hideLoadingSpinner() {
            const spinner = document.getElementById("loadingSpinner");
            if (spinner) {
                spinner.classList.remove("active");
            }
        }

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const sanitizedEmail = user.email.replace(/\./g, "_");

                // Show skeleton loader
                showSkeletonLoader();

                firebase.database().ref(`bookings/${sanitizedEmail}`).once("value", snapshot => {
                    const bookingsDiv = document.getElementById("bookings");
                    bookingsDiv.innerHTML = "";

                    // Hide loading spinner
                    hideLoadingSpinner();

                    if (snapshot.exists()) {
                        snapshot.forEach(booking => {
                            const bookingData = booking.val();
                            const bookingId = booking.key;

                            const bookingHTML = `
                                <div id="${bookingId}">
                                    <p><strong>Movie:</strong> ${bookingData.movie}</p>
                                    <p><strong>Location:</strong> ${bookingData.location}</p>
                                    <p><strong>Showtime:</strong> ${bookingData.showTime}</p>
                                    <p><strong>Seats:</strong> ${bookingData.seats.join(", ")}</p>
                                    <button id="refundBtn" onclick="refund('${bookingId}')">Request Ticket Cancellation</button>
                                </div>
                                <hr>
                            `;
                            bookingsDiv.innerHTML += bookingHTML;
                        });
                    } else {
                        bookingsDiv.innerHTML = '<p class="empty-state">No bookings found. Book your first movie now!</p>';
                    }
                }).catch(error => {
                    hideLoadingSpinner();
                    const bookingsDiv = document.getElementById("bookings");
                    bookingsDiv.innerHTML = '<p class="empty-state">Error loading bookings. Please try again.</p>';
                    console.error("Error loading bookings:", error);
                });
            } else {
                hideLoadingSpinner();
                alert("You need to log in to view your bookings.");
                window.location.href = "login.html";
            }
        });

        function refund(bookId) {
            const user = firebase.auth().currentUser;

            if (user) {
                const userEmail = user.email.replace(/\./g, "_");
                const bookingRef = firebase.database().ref(`bookings/${userEmail}/${bookId}`);

                // Show loading state on button
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = "Processing...";

                bookingRef.once("value")
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const adminPhone = "2349133763902";
                            const message = `Hello, I would like to request a refund for my booking. Booking ID: ${bookId}`;
                            const encodedMessage = encodeURIComponent(message);

                            // Save the refunded booking ID
                            let refundedBookings = JSON.parse(localStorage.getItem("refundedBookings")) || [];
                            if (!refundedBookings.includes(bookId)) {
                                refundedBookings.push(bookId);
                                localStorage.setItem("refundedBookings", JSON.stringify(refundedBookings));
                            }

                            // Redirect to WhatsApp
                            window.location.href = `https://wa.me/${adminPhone}?text=${encodedMessage}`;
                        } else {
                            alert("No booking found to request a refund.");
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching booking data:", error);
                        alert("Error processing refund request. Please try again.");
                        button.disabled = false;
                        button.textContent = originalText;
                    });
            } else {
                alert("You must be logged in to request a refund.");
            }
        }

        setTimeout(() => {
            let refundedBookings = JSON.parse(localStorage.getItem("refundedBookings")) || [];

            refundedBookings.forEach(bookId => {
                let cancelButton = document.querySelector(`[data-booking-id="${bookId}"]`);
                if (cancelButton) {
                    cancelButton.disabled = false;
                }
            });
        }, 2000);
    </script>
</body>
</html>