<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="w" type="image/x-icon">
  <link rel="stylesheet" href="index.css" />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Lora&family=Poppins&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="WhatsApp Image 2025-03-08 at 22.03.05_91a1316a.jpg" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
  <title>My Cinema | Home</title>

  <style>
 

  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="./WhatsApp Image 2025-03-08 at 22.03.05_91a1316a.jpg" alt="">
        <h3>myCinema</h3>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <div class="wrapper">
            <div class="info">
              <!-- <a class="nav-link" href="">About Us</a> -->
            </div>

            <div class="contact">
              <a class="nav-link" href="login.html" id="logIn" style="display: none;">Log In</a>
              <a class="nav-link" href="profile.html" id="profileLink" style="display: none;">Profile</a>
              <button id="logoutBtn" style="display: none;">Logout</button>
              <a class="nav-link" href="contactUs.html">Contact</a>
              <a class="nav-link" href="admin.html">Admin</a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </nav>

  <div class="displayMovies">
    <div id="myCarousel">
      <div class="movieDiv">
        <img src="" alt="Movie Poster" id="moviePoster" />
      </div>
    </div>
    <div id="movieslist">
      <div id="container">
    
      </div>
    </div>
  </div>

  <div id="movieContent">
    <div class="nowshowing">
      <div class="buttons-nd-drops">
        <div class="buttons">
          <button id="nowButton" onclick="nowShowing()">
            Now Showing <span id="number">0</span>
          </button>
          <button id="comingButton" onclick="comingSoon()">
            Coming Soon <span id="numberComing">0</span>
          </button>
        </div>

        <div class="selects">
          <select onchange="changeLocation()" name="" id="location">
            <option value="">Location</option>
            <option value="Oyo">Oyo</option>
            <option value="Ondo">Ondo</option>
            <option value="Lagos">Lagos</option>
          </select>
<!-- 
          <select name="" id="State">
            <option value="">Province</option>
            <option>Dugbe</option>
            <option>Samonda</option>
          </select> -->
        </div>
      </div>

      <h1 class="topic">Now Showing</h1>
      <div id="nowShowingMovies"></div>
    </div>
  </div>

  <div id="comingMovies"></div>

  <div id="movieDetails"></div>

  <div id="seatContainer"></div>


  <!-- Modal -->

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Movie Title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img id="modalPoster" src="" alt="Movie Poster" style="width: 80%; border-radius: 5px; height: 450px" />
          <p id="modalOverview">Movie Overview</p>
          <p id="modalRelease">Release Date:</p>
        </div>
        <!-- <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div> -->
      </div>
    </div>
  </div>
</body>

</html>

<script>
  // ============================================
// API CONFIGURATION
// ============================================
const API_KEY = "77a94d7cd28b61ed2a3df3df25c565be";
const API_BASE_URL = "https://api.themoviedb.org/3";
const IMAGE_BASE_URL = "https://image.tmdb.org/t/p/w500";
const BACKDROP_BASE_URL = "https://image.tmdb.org/t/p/w1280";

// API Endpoints
const API_ENDPOINTS = {
  popular: `${API_BASE_URL}/movie/popular?api_key=${API_KEY}&language=en-US&page=1`,
  nowPlaying: `${API_BASE_URL}/movie/now_playing?api_key=${API_KEY}&language=en-US&page=1`,
  genres: `${API_BASE_URL}/genre/movie/list?api_key=${API_KEY}&language=en-US`
};

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyAyiKbmo11gTMiCtnGat1dmefuCD4SsOQw",
  authDomain: "my-cinema-ffb85.firebaseapp.com",
  databaseURL: "https://my-cinema-ffb85-default-rtdb.firebaseio.com",
  projectId: "my-cinema-ffb85",
  storageBucket: "my-cinema-ffb85.appspot.com",
  messagingSenderId: "1049223253912",
  appId: "1:1049223253912:web:4a244001cd80720753e5ed",
  measurementId: "G-H8NBJJMKX3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ============================================
// GLOBAL STATE
// ============================================
let moviesArray = [];
let genreMap = {};
let currentIndex = 0;
let selectedLocation = '';
let selectedMovie = null;

// DOM Elements
const elements = {
  topic: document.querySelector("h1"),
  moviePoster: document.getElementById("moviePoster"),
  displayMovies: document.querySelector(".displayMovies"),
  container: document.getElementById("container"),
  nowShowingMovies: document.getElementById("nowShowingMovies"),
  movieDetails: document.getElementById("movieDetails"),
  seatContainer: document.getElementById("seatContainer"),
  numberElement: document.getElementById("number"),
  numberComing: document.getElementById("numberComing"),
  locationSelect: document.getElementById("location"),
  // stateSelect: document.getElementById("State")
};

// ============================================
// AUTHENTICATION
// ============================================
auth.onAuthStateChanged((user) => {
  console.log(user ? `User logged in: ${user.email}` : "No user logged in");
  updateAuthUI(user);
});

function updateAuthUI(user) {
  const logoutBtn = document.getElementById("logoutBtn");
  const profileLink = document.getElementById("profileLink");
  const logIn = document.getElementById("logIn");

  if (user) {
    logoutBtn.style.display = "block";
    profileLink.style.display = "block";
    logIn.style.display = "none";
  } else {
    logoutBtn.style.display = "none";
    profileLink.style.display = "none";
    logIn.style.display = "block";
  }
}

function logout() {
  auth.signOut()
    .then(() => {
      alert("Logged out successfully.");
      window.location.href = "index.html";
    })
    .catch((error) => console.error("Logout Error:", error));
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function generateShowDates() {
  const dates = [];
  const today = new Date();
  
  for (let i = 0; i < 7; i++) {
    const futureDate = new Date();
    futureDate.setDate(today.getDate() + i);
    
    dates.push({
      formattedDate: futureDate.toISOString().split("T")[0],
      displayDate: futureDate.toDateString()
    });
  }
  
  return dates;
}

function getGenreNames(genreIds) {
  return genreIds.map((id) => genreMap[id] || "Unknown").join(", ");
}

// ============================================
// GENRE FETCHING
// ============================================
async function fetchGenres() {
  try {
    const response = await fetch(API_ENDPOINTS.genres);
    const data = await response.json();
    genreMap = data.genres.reduce((map, genre) => {
      map[genre.id] = genre.name;
      return map;
    }, {});
  } catch (error) {
    console.error("Error fetching genres:", error);
  }
}

// ============================================
// POPULAR MOVIES CAROUSEL
// ============================================
async function fetchPopularMovies() {
  try {
    const response = await fetch(API_ENDPOINTS.popular);
    const data = await response.json();
    
    moviesArray = data.results;
    updateCarousel(0);
    startCarouselRotation();
    renderPopularMoviesList(moviesArray);
  } catch (error) {
    console.error("Error fetching popular movies:", error);
  }
}

function updateCarousel(index) {
  const movie = moviesArray[index];
  elements.moviePoster.src = `${IMAGE_BASE_URL}${movie.poster_path}`;
  elements.displayMovies.style.backgroundImage = `url(${BACKDROP_BASE_URL}${movie.backdrop_path})`;
  elements.displayMovies.style.backgroundSize = "cover";
}

function startCarouselRotation() {
  setInterval(() => {
    elements.moviePoster.style.opacity = 0;
    
    setTimeout(() => {
      currentIndex = (currentIndex + 1) % moviesArray.length;
      updateCarousel(currentIndex);
      elements.moviePoster.style.opacity = 1;
    }, 1600);
  }, 4000);
}

function renderPopularMoviesList(movies) {
  elements.container.innerHTML = movies
    .map((movie, id) => `
      <div class="listDiv">
        <img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title}" class="listedMovie"> 
        <button type="button" class="seeMoreButton" 
          data-bs-toggle="modal" 
          data-bs-target="#staticBackdrop"
          data-title="${movie.title}" 
          data-overview="${movie.overview}"
          data-release="${movie.release_date}"
          data-poster="${IMAGE_BASE_URL}${movie.poster_path}">
          See More
        </button>
      </div>
    `)
    .join("");

  attachSeeMoreListeners();
}

function attachSeeMoreListeners() {
  document.querySelectorAll(".seeMoreButton").forEach((button) => {
    button.style.opacity = 0;
    
    button.addEventListener("click", function () {
      document.querySelector(".modal-title").textContent = this.getAttribute("data-title").toUpperCase();
      document.getElementById("modalOverview").textContent = this.getAttribute("data-overview");
      document.getElementById("modalRelease").textContent = `Release Date: ${this.getAttribute("data-release")}`;
      document.getElementById("modalPoster").src = this.getAttribute("data-poster");
    });
  });

  document.querySelectorAll(".listDiv").forEach((div) => {
    const button = div.querySelector(".seeMoreButton");
    div.addEventListener("mouseover", () => button.style.opacity = 1);
    div.addEventListener("mouseout", () => button.style.opacity = 0);
  });
}

// ============================================
// NOW SHOWING MOVIES
// ============================================
async function fetchNowShowingMovies() {
  try {
    const response = await fetch(API_ENDPOINTS.nowPlaying);
    const data = await response.json();
    const movies = data.results.slice(4, 14);
    
    elements.topic.innerHTML = selectedLocation 
      ? `Now Showing in ${selectedLocation}` 
      : "Showing all movies. Select location to see what's available near you";
    
    elements.numberElement.innerHTML = movies.length;
    renderNowShowingMovies(movies);
  } catch (error) {
    console.error("Error fetching now showing movies:", error);
  }
}

function renderNowShowingMovies(movies) {
  console.log(movies);
  
  elements.nowShowingMovies.innerHTML = movies
    .map((movie) => createMovieCard(movie))
    .join("");
  
  attachMovieCardListeners();
}

function createMovieCard(movie) {
  return `
    <a href="#movieDetails" class="movie-link" data-movie='${JSON.stringify(movie).replace(/'/g, "&apos;")}'>
      <div class="nowShowingClass">
        <img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title}" class="poster">
        <div class="showingMovieTitle">${movie.title}</div>
        <div class="showingMovieGenres">${getGenreNames(movie.genre_ids)}</div>
      </div>
    </a>
  `;
}

function attachMovieCardListeners() {
  document.querySelectorAll(".movie-link").forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const movieData = JSON.parse(event.currentTarget.getAttribute("data-movie"));
      localStorage.setItem("TheMovieData", JSON.stringify(movieData));
      displayMovieDetails(movieData);
    });
  });
}

function displayMovieDetails(movie) {
  const availableDates = generateShowDates();
  const hasShowtimes = selectedLocation && selectedLocation !== "";

  elements.movieDetails.innerHTML = `
    <div class="detailClass">
      <img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title}" class="posterDetails">
      
      <div class="inside">
        <div class="movieDetailTitle">${movie.title}</div>
        <div class="movieDetailGenres">${getGenreNames(movie.genre_ids)}</div>
        <div class="movieDetailedOverview">${movie.overview}</div>
        <div class="movieDetailedOverview">Release Date: ${movie.release_date}</div>
        <div class="movieDetailedOverview">Rating: ${movie.vote_average}</div>
        <div class="movieDetailedOverview">Language: ${movie.original_language}</div>

        ${hasShowtimes ? `
          <div class="showtimeSection">
            <label for="showDate-${movie.id}">Select Date:</label>
            <select id="showDate-${movie.id}" class="dateAndtime">
              ${availableDates.map(date => `<option value="${date.formattedDate}">${date.displayDate}</option>`).join("")}
            </select>

            <label for="showTime-${movie.id}">Select Showtime:</label>
            <select id="showTime-${movie.id}" class="showTime dateAndtime" onchange="fetchSeats(${movie.id})">
              <option value="">Select Time</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="6:00 PM">6:00 PM</option>
              <option value="9:00 PM">9:00 PM</option>
            </select>
          </div>

          <button class="buyTicket" onclick="buyMovieTicket(${movie.id})">Buy Ticket</button>
        ` : `
          <button class="buyTicket" onclick="alert('Please select a location first')">Select Location First</button>
        `}

        <a href="#movieContent">
          <button class="backToMovies">Back to Movies</button>
        </a>
      </div>
    </div>
  `;
  
  elements.movieDetails.scrollIntoView({ behavior: "smooth" });
}

// ============================================
// LOCATION FILTERING
// ============================================
function changeLocation() {
  selectedLocation = elements.locationSelect.value;
  
  const locationConfig = {
    "Oyo": { movieRange: [12, 18] },
    "Lagos": {  movieRange: [5, 10] },
    "Ondo": {  movieRange: [1, 7] }
  };

  const config = locationConfig[selectedLocation];
  
  if (config) {
    filterMoviesByLocation(selectedLocation, config.movieRange);
  } else {
    fetchNowShowingMovies();
  }
}

async function filterMoviesByLocation(location, range) {
  try {
    const response = await fetch(API_ENDPOINTS.nowPlaying);
    const data = await response.json();
    const movies = data.results.slice(range[0], range[1]);
    
    elements.topic.innerHTML = `Now Showing in ${location}`;
    elements.numberElement.innerHTML = movies.length;
    renderNowShowingMovies(movies);
  } catch (error) {
    console.error("Error filtering movies:", error);
  }
}

// ============================================
// COMING SOON MOVIES
// ============================================
async function fetchComingSoonMovies() {
  try {
    const response = await fetch(API_ENDPOINTS.nowPlaying);
    const data = await response.json();
    const movies = data.results.slice(13, 18);
    
    elements.topic.innerHTML = selectedLocation 
      ? `Coming Soon in ${selectedLocation}` 
      : "Coming to My Cinema Soon";
    
    elements.numberComing.innerHTML = movies.length;
    renderComingSoonMovies(movies);
  } catch (error) {
    console.error("Error fetching coming soon movies:", error);
  }
}

function renderComingSoonMovies(movies) {
  elements.nowShowingMovies.innerHTML = movies
    .map((movie) => createMovieCard(movie))
    .join("");
  
  // Attach listeners for coming soon movies
  document.querySelectorAll(".movie-link").forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const movieData = JSON.parse(event.currentTarget.getAttribute("data-movie"));
      displayComingSoonDetails(movieData);
    });
  });
}

function displayComingSoonDetails(movie) {
  elements.movieDetails.innerHTML = `
    <div class="detailClass">
      <img src="${IMAGE_BASE_URL}${movie.poster_path}" alt="${movie.title}" class="posterDetails">
      
      <div class="inside">
        <div class="movieDetailTitle">${movie.title}</div>
        <div class="movieDetailGenres">${getGenreNames(movie.genre_ids)}</div>
        <div class="movieDetailedOverview">${movie.overview}</div>
        <div class="movieDetailedOverview">Release Date: ${movie.release_date}</div>
        <div class="movieDetailedOverview">Rating: ${movie.vote_average}</div>
        <div class="movieDetailedOverview">Language: ${movie.original_language}</div>
        
        <button class="buyTicket">Coming Soon</button>
        <a href="#movieContent">
          <button class="buyTicket">Back to Movies</button>
        </a>
      </div>
    </div>
  `;
  
  elements.movieDetails.scrollIntoView({ behavior: "smooth" });
}

// ============================================
// SEAT MANAGEMENT
// ============================================
function initializeSeats(location, showtime, movieId) {
  const seatsRef = db.ref(`seats/${location}/${showtime}/${movieId}`);

  seatsRef.once("value").then(snapshot => {
    if (!snapshot.exists()) {
      const seatsData = {};
      for (let i = 1; i <= 50; i++) {
        seatsData[i] = { available: true };
      }

      seatsRef.set(seatsData)
        .then(() => console.log(`Seats initialized for ${location} at ${showtime} for movie ID ${movieId}`))
        .catch(error => console.error("Error initializing seats:", error));
    }
  });
}

function fetchSeats(movieId) {
  const showtimeElement = document.querySelector(".showTime");
  if (!showtimeElement) return;
  
  const selectedShowtime = showtimeElement.value;
  if (!selectedShowtime || !selectedLocation) return;

  const seatsRef = db.ref(`seats/${selectedLocation}/${selectedShowtime}/${movieId}`);

  seatsRef.once("value", (snapshot) => {
    if (snapshot.exists()) {
      loadSeats(selectedLocation, selectedShowtime, movieId);
    } else {
      initializeSeats(selectedLocation, selectedShowtime, movieId);
      loadSeats(selectedLocation, selectedShowtime, movieId);
    }
  });
}

function loadSeats(location, showtime, movieId) {
  const seatsRef = db.ref(`seats/${location}/${showtime}/${movieId}`);
  const buyTicketBtn = document.querySelector('.buyTicket');

  seatsRef.once("value", (snapshot) => {
    const seatsData = snapshot.val() || {};
    elements.seatContainer.innerHTML = "";

    for (let i = 1; i <= 50; i++) {
      const seatElement = document.createElement("button");
      seatElement.innerText = `Seat ${i}`;
      seatElement.classList.add("seat");

      if (seatsData[i]?.available === false) {
        seatElement.classList.add("booked");
        seatElement.disabled = true;
      } else {
        seatElement.addEventListener("click", function () {
          this.classList.toggle("selected");
          console.log(seatElement);
          
          if (buyTicketBtn) {
            buyTicketBtn.style.backgroundColor = 'green';
          }
        });
      }

      elements.seatContainer.appendChild(seatElement);
    }
  });
}

// ============================================
// TICKET BOOKING
// ============================================
function buyMovieTicket(movieId) {
  const user = auth.currentUser;
  console.log(movieId);
  
  if (!user) {
    alert('Please log in first');
    window.location.href = 'login.html';
    return;
  }

  const selectedSeats = [...document.querySelectorAll(".seat.selected")].map(seat => seat.innerText);
  console.log(selectedSeats);
  
  const showtimeElement = document.querySelector(".showTime");
  const showtime = showtimeElement ? showtimeElement.value : '';
  const movieTitle = document.querySelector(".movieDetailTitle")?.innerText || '';

  if (!showtime) {
    alert("Kindly select a showtime and at least one seat");
    return;
  }

  if (selectedSeats.length === 0) {
    alert("No seats selected! Scroll down to select a seat");
    return;
  }

  const ticketData = {
    UserID: Date.now(),
    amount: selectedSeats.length,
    showTime: showtime,
    location: selectedLocation,
    movie: movieTitle,
    seats: selectedSeats,
    movieId: movieId,
    timestamp: new Date().toISOString()
  };

  localStorage.setItem("ticketData", JSON.stringify(ticketData));
  window.location.href = "booking.html";
}

// ============================================
// INITIALIZATION
// ============================================
async function initialize() {
  await fetchGenres();
  await fetchPopularMovies();
  await fetchNowShowingMovies();
}

// Event Listeners
document.addEventListener("DOMContentLoaded", () => {
  initialize();
  
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", logout);
  }
});

// Export functions for global access (if needed)
window.changeLocation = changeLocation;
window.fetchSeats = fetchSeats;
window.buyMovieTicket = buyMovieTicket;
window.nowShowing = fetchNowShowingMovies;
window.comingSoon = fetchComingSoonMovies;
</script>